{% extends "base.html" %}
<!-- Title -->
{% block title %}Time sheet analysis Analysis{% endblock %}
{% block dashboard_active %}active{% endblock %}
<!-- head -->
{% block Head %}

<style>
    @media (min-width: 1367px) {
        #chartdiv {
            width: 100%;
            height: 28.5dvh;
        }
    }
    @media (max-width: 1366px) {
        #chartdiv {
            width: 100%;
            height: 30dvh;
        }
    }
    #Piechartdiv {
        width: 100%;
        height: 34dvh;
    }
    .hide_column {
  display: none;
}
.text-nowrap {
  text-wrap: nowrap;
}
</style>
<script>
    // am4core.ready(function() {
    function xyChart(xydata){
        // Themes begin
        am4core.useTheme(am4themes_animated);
        // Themes end

        // Create chart instance
        var chart = am4core.create("chartdiv", am4charts.XYChart);
        chart.logo.dispose();
        // chart.scrollbarX = new am4core.Scrollbar();
        // Add data
        // chart.data = {{ data | safe}};
        chart.data = xydata
        // Create axes
        var categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
        categoryAxis.dataFields.category = "day";
        categoryAxis.title.text = "Worked Dates";
        categoryAxis.renderer.grid.template.location = 0;
        categoryAxis.renderer.minGridDistance = 20;
        categoryAxis.renderer.cellStartLocation = 0.1;
        categoryAxis.renderer.cellEndLocation = 0.9;

        var label = categoryAxis.renderer.labels.template;
        // label.truncate = true;
        label.maxWidth = 120;
        label.wrap = true;

        var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
        valueAxis.min = 0;
        valueAxis.title.text = "Worked Hours";

        // Create series
        function createSeries(field, name, stacked) {
            var series = chart.series.push(new am4charts.ColumnSeries());
            series.dataFields.valueY = field;
            series.dataFields.categoryX = "day";
            series.name = name;
            series.columns.template.tooltipText = "{_pro_name}: Total- [bold]{valueY}[/] hrs";
            series.stacked = stacked;
            series.columns.template.width = am4core.percent(55);
        }
        createSeries("total_hrs", "_pro_name", true);
        // Add legend
        //chart.legend = new am4charts.Legend();
    }
    // }); // end am4core.ready()
</script>
<!-- Pie chart -->
<script>
    // am4core.ready(function() {
    function pieChart(pieData){
        // Themes begin
        am4core.useTheme(am4themes_animated);
        // Themes end

        // Create chart instance
        var piechart = am4core.create("Piechartdiv", am4charts.PieChart);
        piechart.logo.dispose();
        // Add and configure Series
        var pieSeries = piechart.series.push(new am4charts.PieSeries());
        pieSeries.dataFields.value = "total_hrs";
        pieSeries.dataFields.category = "project_name";

        // Let's cut a hole in our Pie chart the size of 30% the radius
        piechart.innerRadius = am4core.percent(35);

        // Put a thick white border around each Slice
        pieSeries.slices.template.stroke = am4core.color("#fff");
        pieSeries.slices.template.strokeWidth = 2;
        pieSeries.slices.template.strokeOpacity = 1;
        pieSeries.slices.template
            // change the cursor on hover to make it apparent the object can be interacted with
            .cursorOverStyle = [{
                "property": "cursor",
                "value": "pointer"
            }];

        pieSeries.alignLabels = false;
        pieSeries.labels.value = false;
        //pieSeries.labels.template.bent = false;
        // pieSeries.labels.template.radius = 3;
        // pieSeries.labels.template.padding(0,0, 0, 0);
        pieSeries.alignLabels = true;
        pieSeries.labels.template.maxWidth = 70;
        pieSeries.labels.template.wrap = true;
        pieSeries.labels.template.fontSize = 10;
        pieSeries.labels.template.text = "{task_id__pid__name}";

       // pieSeries.ticks.template.disabled = true;

        // Create a base filter effect (as if it's not there) for the hover to return to
        var shadow = pieSeries.slices.template.filters.push(new am4core.DropShadowFilter);
        shadow.opacity = 0;

        // Create hover state
        var hoverState = pieSeries.slices.template.states.getKey("hover"); // normally we have to create the hover state, in this case it already exists

        // Slightly shift the shadow and make it more prominent on hover
        var hoverShadow = hoverState.filters.push(new am4core.DropShadowFilter);
        hoverShadow.opacity = 0.7;
        hoverShadow.blur = 5;

        // Add a legend
        // piechart.legend = new am4charts.Legend();

        // piechart.data = {{project_hours | safe}};
        piechart.data =pieData
    }
    // }); // end am4core.ready()
</script>
{% endblock %}

<!-- Main content -->
{% block main-content %}

<!--  Timesheet Bar Chart and  project Pie Chart -->
<div class="row justify-content-center mx-auto"> 
    <div class="col-sm-12 col-md-12 col-lg-9  px-0">
        <div class="card">
            <div class="card-header">
                <div class="justify-content-between row" style="height: 28px;">
                    <div class="col-12 col-md-4 lg-2 ">
                        <label for=""></label>
                        <i class="fas fa-chart-bar me-1"></i><strong >Worked Hours : </strong><label style="font-weight: bold; color: green;" id="totalWorkedhrs"></label>
                    </div>
                    <div class="col-12 col-md-8 lg-10 ">
                            <form action="" id="filterForm" method="POST">
                            {% csrf_token %}
                            <div class="row justify-content-end">
                                <div class="col-6 col-md-6 col-lg-3 mb-1">
                                    <div class="form-outline ">
                                        <input type="date" id="from_date" name="from_date" required   class="form-control filter-Date" />
                                        <label class="form-label" for="from_date"><i class="fas fa-filter"></i>From</label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-6 col-lg-3 mb-1">
                                    <div class="form-outline ">
                                        <input type="date" id="to_date" name="to_date" value="" required class="form-control filter-Date" />
                                        <label class="form-label" for="to_date"><i class="fas fa-filter"></i>To</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-body ">
                <div id="chartdiv"></div>
            </div>
        </div>
    </div>
    <div class="col-sm-12 col-md-12 col-lg-3 ps-1 pe-0">
        <div class="card ">
            <div class="card-header">
                <i class="fas fa-chart-pie"></i> <strong>Project Hours</strong>
            </div>
            <div class="card-body p-0">
                <div id="Piechartdiv"></div>
            </div>
        </div>
    </div>
</div>

<!--Timesheet Submit table -->
<div class="row mt-1 justify-content-center  mx-auto" >
    <div class="col-sm-12 col-md-12 col-lg-12 px-1">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table"></i> <strong>TimeSheet Log</strong>
                <!-- <span  class=" text-info">*Note: To edit or delete a row, double-click it.</span> -->
            </div>
            <div class="card-body">
                <table  class="dataTable display compact cell-border" id="datatables" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Milestone</th>
                            <th>Task</th>
                            <th>Date</th>
                            <th>HRS</th>
                            <th>Comment</th>
                            <th>id</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

 <!-- Edit timesheet Modal -->
 <div class="modal fade" id="Edit_Submission_Modal" tabindex="-1" aria-labelledby="Edit_Submission_Modal" aria-hidden="true">
    <div class="modal-dialog  modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel" >Edit/Delete Submission</h5>
                <button type="button" id="close" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" id="Edit_Form" method="">
                    {% csrf_token %}
                     <div class="justify-content-around row mb-2">
                        <div class="col-6 col-md-6 col-lg-8">
                            <div class="form-outline">
                                <input type="text" readonly class="form-control" name="project_name" value=""  id="E_project" required>
                                <label class="form-label" for="project_name">Project</label>
                            </div>
                        </div>
                        <div class="col-6 col-md-6 col-lg-4 ">
                            <div class="form-outline">
                                <input type="date" class="form-control" id="E_sub_date" name="date" value="" required>
                                <label class="form-label" for="E_sub_date">Date</label>
                            </div>
                        </div>
                    </div>
                    <div class="justify-content-around row mb-2">
                        <div class="col-12 col-md-6 col-lg-8">
                            <div class="form-outline">
                                <input type="text" readonly class="form-control" name="task" value=""  id="E_task" required>
                                <label class="form-label" for="task">Task</label>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="form-outline ">
                                <input type="text" class="form-control" id="E_hours" name="hours" value="" min="0" max="15" required>
                                <label class="form-label" for="E_hours">Hours</label>
                            </div>
                        </div>   
                    </div>
                    <div class="justify-content-around row mb-2">                         
                         <div class="col-12 col-md-6 col-lg-12">
                            <div class="form-outline">
                                   <textarea class="form-control"  id="E_comment" name="comment" value="" cols="30" rows="5" required></textarea>
                                   <label class="form-label" for="E_comment">Comment</label>
                               </div>
                           </div>
                    </div>
                    <!-- submit -->
                    <div class="justify-content-between row mb-2">  
                        <div class="col-6 col-md-4 col-lg-3" >
                            <span style="display: none;"><input type="text" class="form-control" id="E_id" name="id" value="" required></span>
                            <button type="submit" id="updateTaskbtn" class="form-control bg-info">SUBMIT</button> 
                        </div>
                        <div class="col-6 col-md-4 col-lg-3" >
                            <span style="display: none;">
                                <label class="form-group border-lable-flt">
                                    <select class="form-control custom-select" id="E_location" name="location"  style="height: 37px" required>
                                        <option value="Office">Office</option>
                                        <option value="On-site">On-site</option>
                                        <option value="Home">Home</option>
                                    </select>
                                    <span>Location</span>
                                </label>
                            </span>
                            <button class="form-control bg-danger" id="deletebtn" >DELETE </button>
                        </div>
                    </div>
                </form>
            </div>            
        </div>
    </div>
</div>


<script>
    $(document).ready(function() {
    $.ajax({
        url:"{% url 'getTimesheetLogs'%}",
            type:"GET",
            dataType:"json",
            success:function(response){
                pieChart(response.pieData)
                xyChart(response.xyData)
                document.getElementById("from_date").value = response.from_date;
                document.getElementById("to_date").value = response.to_date;
                document.getElementById("from_date").max = response.to_date;
                document.getElementById("to_date").min = response.from_date;
                document.getElementById("to_date").focus()
                document.getElementById("from_date").focus()
                $('#totalWorkedhrs').html(response.totalWorkedHours.hrs +":hrs");
                loadDatatable(response.logs)
            }
    });
    
    $(".filter-Date").change(function (e){
        e.preventDefault();
        if (this.id =='from_date') {document.getElementById("to_date").min = this.value }
        var formdata = $("#filterForm").serialize()
        formdata+='&mode=filter_timesheetlog'
        let args = {type:"POST", url:"{%url 'getTimesheetLogs'%}", jsonData:formdata};
        ajaxRquest(args);
    });

//     $("#updateTaskbtn").click(function (e) {
//         e.preventDefault();
//         var fromdate = document.getElementById("from_date").value;
//         var todate = document.getElementById("to_date").value;
//         var formdata = $("#Edit_Form").serialize()
//         formdata+='&mode=edit_timesheetlog&from_date='+fromdate+'&to_date='+todate
//         let args = {type:"POST", url:"{%url 'getTimesheetLogs'%}", jsonData:formdata};
//         ajaxRquest(args);
//     }); 

//     $('#deletebtn').click(function(e){
//         e.preventDefault();
//         var fromdate = document.getElementById("from_date").value;
//         var todate = document.getElementById("to_date").value;
//         var formdata =$("#Edit_Form").serialize()
//         formdata+='&mode=delete_timesheetlog&from_date='+fromdate+'&to_date='+todate
//         let args = {type:"POST", url:"{%url 'getTimesheetLogs'%}", jsonData:formdata};
//         ajaxRquest(args);
//    })
   
    function ajaxRquest(args){
        $.ajax({
            type:args.type,
            url:args.url,
            data:args.jsonData,
            dataType:"json",
            headers:{'X-CSRFToken':'{% csrf_token %}'},
            success: function(response) {
                pieChart(response.pieData)
                xyChart(response.xyData)
                document.getElementById("from_date").value = response.from_date;
                document.getElementById("to_date").value = response.to_date;
                document.getElementById("from_date").max = response.to_date;
                document.getElementById("to_date").min = response.from_date;
                $('#totalWorkedhrs').html(response.totalWorkedHours.hrs +":hrs");
                loadDatatable(response.logs)
                $("#Edit_Submission_Modal").modal('hide');
            }
            });
    };
    
    function loadDatatable(tableData){
        var table = $('.dataTable').DataTable({
            data:tableData,
            order: [
                    [3, 'desc']
                ],
            columns: [
                {data: 'task_id__pid__name'}, 
                {data: 'task_id__mid__name'},
                {data: 'task_id__name'},
                {data: 'date'}, 
                {data: 'hours'},
                {data: 'comment'},
                {data: 'id'}
        ],
            // dom: 'Bfrtip',
           // buttons: ['excel'], 'pdf', 'print' ,'copy', 'csv',
            searching: false,
            paging: false,
            scrollCollapse: true,
            scrollY: '35dvh',
            columnDefs : [  { className : "text-center",targets:[3,4]},
                            { className : "text-nowrap",targets:[2]},
                            { className : "hide_column",targets:[6]},
                            { "width": "10%", "targets": [3,4 ]}],
            responsive: true,
            destroy: true,
            });
    };

    // $('.dataTable').on('dblclick','tr',function(e){
    //         var dataRow = $('.dataTable').DataTable().row($(this).closest('tr')).data();
    //         $('#E_project').val(dataRow.task_id__pid__name);
    //         $('#E_task').val(dataRow.task_id__name);
    //         $('#E_sub_date').val(dataRow.date);
    //         $('#E_hours').val(dataRow.hours);
    //         $('#E_comment').val(dataRow.comment);
    //         $('#E_id').val(dataRow.id);
    //         $('#Edit_Submission_Modal').modal('show');
    //     });

    // $(".btn-close").click(function(e){
    //     $("#Edit_Submission_Modal").modal('hide');
    // });

});
</script>

{% endblock %}